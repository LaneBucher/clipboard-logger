<?xml version='1.0' encoding='windows-1252'?>
<!--
  Copyright (C) 2017 Christopher R. Field.
  Licensed under the Apache License, Version 2.0 (the "License");
  http://www.apache.org/licenses/LICENSE-2.0
-->

<?if $(sys.BUILDARCH) = x64 or $(sys.BUILDARCH) = arm64 ?>
    <?define PlatformProgramFilesFolder = "ProgramFiles64Folder" ?>
<?else ?>
    <?define PlatformProgramFilesFolder = "ProgramFilesFolder" ?>
<?endif ?>

<Wix xmlns='http://schemas.microsoft.com/wix/2006/wi'>

  <Product
      Id='*'
      Name='clipboard-logger'
      UpgradeCode='B01AB354-C750-4ED4-9435-61623AF75620'
      Manufacturer='Lane Bucher'
      Language='1033'
      Codepage='1252'
      Version='$(var.Version)'>

    <Package Id='*'
        Keywords='Installer'
        Manufacturer='Lane Bucher'
        InstallerVersion='450'
        Languages='1033'
        Compressed='yes'
        InstallScope='perMachine'
        SummaryCodepage='1252' />

    <MajorUpgrade
        Schedule='afterInstallInitialize'
        DowngradeErrorMessage='A newer version of [ProductName] is already installed. Setup will now exit.'/>

    <Media Id='1' Cabinet='media1.cab' EmbedCab='yes' DiskPrompt='CD-ROM #1'/>
    <Property Id='DiskPrompt' Value='clipboard-logger Installation'/>

    <Directory Id='TARGETDIR' Name='SourceDir'>
      <Directory Id='$(var.PlatformProgramFilesFolder)' Name='PFiles'>
        <Directory Id='APPLICATIONFOLDER' Name='clipboard-logger'>

          <!-- License sidecar -->
          <Component Id='License' Guid='*'>
            <File Id='LicenseFile'
                  DiskId='1'
                  Source='wix\License.rtf'
                  KeyPath='yes'/>
          </Component>

          <Directory Id='Bin' Name='bin'>
            <Component Id='Path' Guid='D83D4723-60FB-40CE-B9BE-BED25FFCE769' KeyPath='yes'>
              <Environment
                Id='PATH'
                Name='PATH'
                Value='[Bin]'
                Permanent='no'
                Part='last'
                Action='set'
                System='yes'/>
            </Component>

            <!-- Installed executable -->
            <Component Id='binary0' Guid='*'>
              <File
                Id='exe0'
                Name='clipboard-logger.exe'
                DiskId='1'
                Source='$(var.CargoTargetBinDir)\clipboard-logger.exe'
                KeyPath='yes'/>
            </Component>
          </Directory>

        </Directory>
      </Directory>
    </Directory>

    <Feature
        Id='Binaries'
        Title='Application'
        Description='Installs all binaries and the license.'
        Level='1'
        ConfigurableDirectory='APPLICATIONFOLDER'
        AllowAdvertise='no'
        Display='expand'
        Absent='disallow'>

      <ComponentRef Id='License'/>
      <ComponentRef Id='binary0'/>

      <Feature
          Id='Environment'
          Title='PATH Environment Variable'
          Description='Add the install location of the [ProductName] executable to the PATH system environment variable. This allows the [ProductName] executable to be called from any location.'
          Level='1'
          Absent='allow'>
        <ComponentRef Id='Path'/>
      </Feature>
    </Feature>

    <SetProperty Id='ARPINSTALLLOCATION' Value='[APPLICATIONFOLDER]' After='CostFinalize'/>

    <!-- Optional product icon -->
    <!-- <Icon Id='ProductICO' SourceFile='wix\Product.ico'/> -->
    <!-- <Property Id='ARPPRODUCTICON' Value='ProductICO' /> -->

    <!-- Optional help link -->
    <!-- <Property Id='ARPHELPLINK' Value='https://github.com/LaneBucher/clipboard-logger'/> -->

    <UI>
      <UIRef Id='WixUI_FeatureTree'/>
      <!-- To disable the EULA dialog, adjust variables below -->
    </UI>

    <!-- EULA sidecar (remove this line to disable the license dialog entirely) -->
    <WixVariable Id='WixUILicenseRtf' Value='wix\License.rtf'/>

    <CustomAction
        Id="RunDaemon"
        Directory="APPLICATIONFOLDER"
        ExeCommand="&quot;[#exe0]&quot; --daemon"
        Return="asyncNoWait" />

    <InstallExecuteSequence>
      <!-- Run after files are finalized; only on fresh install -->
      <Custom Action="RunDaemon" After="InstallFinalize">NOT Installed</Custom>
    </InstallExecuteSequence>

    <!-- Optional banner/dialog images -->
    <!-- <WixVariable Id='WixUIBannerBmp' Value='wix\Banner.bmp'/> -->
    <!-- <WixVariable Id='WixUIDialogBmp' Value='wix\Dialog.bmp'/> -->

  </Product>

</Wix>
